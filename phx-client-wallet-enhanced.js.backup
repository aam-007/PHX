// phxClientWallet.ui.js
// Formal PHX Client Wallet UI (no emojis, no gradient)
// npm install chalk@4 figlet ora@5 cli-table3
// NOTE: Use chalk v4 and ora v5 for CommonJS compatibility if needed.

const { ethers } = require("hardhat");
const readline = require("readline");

const chalk = require("chalk");
const figlet = require("figlet");
const ora = require("ora");
const Table = require("cli-table3");

const CONFIG = {
  PHX_TOKEN_ADDRESS: "0x6652bfFF72971c548Fb70247abEA69A45427dB50",
  NETWORK: "ganache"
};

class PHXClientWallet {
  constructor() {
    this.phx = null;
    this.availableAccounts = [];
    this.userAccounts = [];
    this.currentUser = null;
    this.rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout
    });

    // color theme (formal)
    this.theme = {
      title: chalk.blueBright,
      section: chalk.cyanBright,
      label: chalk.yellow,
      value: chalk.white,
      ok: chalk.greenBright,
      warn: chalk.yellowBright,
      err: chalk.redBright,
      dim: chalk.gray
    };
  }

  // ---------- UI helpers ----------
  fancyTitle(text) {
    try {
      const fig = figlet.textSync(text, { font: "Small", horizontalLayout: "fitted" });
      console.log(this.theme.title(fig));
    } catch (e) {
      console.log(this.theme.title(`\n${text}\n`));
    }
  }

  section(title) {
    const border = "─".repeat(58);
    console.log("\n" + this.theme.title("┌" + border + "┐"));
    console.log(this.theme.title("│") + " " + this.theme.section.bold(title.padEnd(56)) + this.theme.title("│"));
    console.log(this.theme.title("└" + border + "┘") + "\n");
  }

  smallNote(msg) { console.log(this.theme.dim(`\n${msg}\n`)); }
  error(msg) { console.log(this.theme.err(`\nERROR: ${msg}\n`)); }
  success(msg) { console.log(this.theme.ok(`\n${msg}\n`)); }

  // ---------- initialization ----------
  async initialize() {
    console.clear();
    this.fancyTitle("PHX WALLET");
    console.log(this.theme.dim("=".repeat(64)));
    console.log(this.theme.value("Starting PHX Client Wallet"));
    console.log(this.theme.warn("Ensure Ganache/Hardhat is running at http://127.0.0.1:7545"));
    console.log(this.theme.err("Treasury account is restricted to Central Bank Console"));
    console.log(this.theme.dim("=".repeat(64) + "\n"));

    const spinner = ora("Connecting to local node and loading accounts...").start();
    try {
      this.availableAccounts = await ethers.getSigners();
      if (!this.availableAccounts || this.availableAccounts.length === 0) {
        spinner.fail("No signers available");
        this.error("No local accounts available from ethers.getSigners()");
        return false;
      }

      // exclude treasury (index 0)
      this.userAccounts = this.availableAccounts.slice(1);
      spinner.succeed("Accounts loaded");

      const PHX = await ethers.getContractFactory("PhonexCoin");
      this.phx = await PHX.attach(CONFIG.PHX_TOKEN_ADDRESS);

      this.success("Client Wallet connected successfully");
      console.log(this.theme.label("PHX Token Address: ") + this.theme.value(CONFIG.PHX_TOKEN_ADDRESS));
      this.smallNote("Treasury account hidden for security");

      await this.selectUser();
      return true;
    } catch (error) {
      spinner.fail("Initialization failed");
      this.error(error?.message || String(error));
      return false;
    }
  }

  // ---------- input helpers ----------
  question(prompt) {
    return new Promise((resolve) => { this.rl.question(prompt, resolve); });
  }

  async getAddressFromUser(prompt) {
    while (true) {
      const input = (await this.question(prompt)).trim();

      // numeric index
      if (input !== "" && !isNaN(input)) {
        const idx = parseInt(input);
        if (idx >= 0 && idx < this.userAccounts.length) {
          return this.userAccounts[idx].address;
        }
      }

      // address string
      try {
        if (ethers.isAddress(input)) {
          const treasuryAddress = this.availableAccounts[0].address.toLowerCase();
          if (input.toLowerCase() === treasuryAddress) {
            this.error("Treasury account cannot be accessed.");
            continue;
          }
          return input;
        }
      } catch (e) {
        // ignore
      }

      this.error(`Invalid address/index. Valid index: 0-${this.userAccounts.length - 1}.`);
    }
  }

  async getAmountFromUser(prompt) {
    while (true) {
      const input = (await this.question(prompt)).trim();
      const val = parseFloat(input);
      if (!isNaN(val) && val > 0) return input;
      this.error("Invalid amount. Enter a positive number.");
    }
  }

  // ---------- account selection ----------
  async selectUser() {
    this.section("SELECT CURRENT USER ACCOUNT");

    try {
      const table = new Table({
        head: [this.theme.section("Idx"), this.theme.section("Address"), this.theme.section("Balance (PHX)")],
        colWidths: [6, 48, 18]
      });

      for (let i = 0; i < this.userAccounts.length; i++) {
        const addr = this.userAccounts[i].address;
        const bal = await this.phx.balanceOf(addr);
        table.push([this.theme.value(i.toString()), this.theme.value(addr), this.theme.ok(ethers.formatUnits(bal, 18))]);
      }

      console.log(table.toString());

      while (true) {
        const choice = await this.question(this.theme.warn(`\nSelect account index (0-${this.userAccounts.length - 1}): `));
        const index = parseInt(choice);
        if (!isNaN(index) && index >= 0 && index < this.userAccounts.length) {
          this.currentUser = this.userAccounts[index];
          const balance = await this.phx.balanceOf(this.currentUser.address);
          this.success(`Selected account ${index} | Balance: ${ethers.formatUnits(balance, 18)} PHX`);
          break;
        }
        this.error("Invalid index.");
      }
    } catch (error) {
      this.error("Account selection failed: " + (error?.message || String(error)));
      throw error;
    }
  }

  // ---------- operations ----------
  async checkMyBalance() {
    this.section("MY BALANCE");
    try {
      const balance = await this.phx.balanceOf(this.currentUser.address);
      console.log(this.theme.label("Address: ") + this.theme.value(this.currentUser.address));
      console.log(this.theme.label("Balance: ") + this.theme.ok(`${ethers.formatUnits(balance, 18)} PHX`));
    } catch (error) {
      this.error(error?.message || String(error));
    }
  }

  async checkAddressBalance() {
    this.section("CHECK ADDRESS BALANCE");

    try {
      // Display available accounts first
      const table = new Table({
        head: [this.theme.section("Idx"), this.theme.section("Address"), this.theme.section("Balance (PHX)")],
        colWidths: [6, 48, 18]
      });

      for (let i = 0; i < this.userAccounts.length; i++) {
        const addr = this.userAccounts[i].address;
        const bal = await this.phx.balanceOf(addr);
        table.push([this.theme.value(i.toString()), this.theme.value(addr), this.theme.ok(ethers.formatUnits(bal, 18))]);
      }

      console.log(table.toString());
      console.log(this.theme.dim("\nAvailable wallet addresses listed above"));
      console.log(this.theme.dim("You can also enter any valid Ethereum address"));

      // Get address input
      const address = await this.getAddressFromUser("Enter address or index: ");
      const balance = await this.phx.balanceOf(address);

      // Display result
      this.section("BALANCE CHECK RESULT");
      console.log(this.theme.label("Address: ") + this.theme.value(address));
      console.log(this.theme.label("Balance: ") + this.theme.ok(`${ethers.formatUnits(balance, 18)} PHX`));
      
    } catch (error) {
      this.error(error?.message || String(error));
    }
  }

  // ---------- transfer ----------
  async transferToUser() {
    this.section("TRANSFER PHX");

    try {
      let recipient;
      while (true) {
        console.log(this.theme.section("\nRecipient Options:"));
        console.log(this.theme.value(" 1. Enter address or index"));
        console.log(this.theme.value(" 2. View available accounts"));
        console.log(this.theme.value(" 3. Cancel transfer\n"));

        const opt = (await this.question(this.theme.warn("Select an option (1–3): "))).trim();

        if (opt === "1") {
          recipient = await this.getAddressFromUser("Enter recipient: ");
          break;
        } else if (opt === "2") {
          await this.viewAllBalances();
        } else if (opt === "3") {
          this.smallNote("Transfer cancelled.");
          return;
        } else {
          this.error("Invalid option.");
        }
      }

      const amountStr = await this.getAmountFromUser("Enter amount of PHX to transfer: ");
      const amountWei = ethers.parseUnits(amountStr, 18);

      console.log(this.theme.dim("\nTransfer summary:"));
      console.log(this.theme.label(" From:     ") + this.theme.value(this.currentUser.address));
      console.log(this.theme.label(" To:       ") + this.theme.value(recipient));
      console.log(this.theme.label(" Amount:   ") + this.theme.value(`${amountStr} PHX`));
      console.log(this.theme.label(" Fee:      ") + this.theme.value("0 PHX (No fees)"));
      console.log(this.theme.label(" Total:    ") + this.theme.value(`${amountStr} PHX`));

      const confirm = (await this.question(this.theme.warn("\nConfirm transfer? (y/n): "))).trim().toLowerCase();
      if (confirm !== "y" && confirm !== "yes") {
        this.smallNote("Transfer cancelled.");
        return;
      }

      const bal = await this.phx.balanceOf(this.currentUser.address);
      if (bal < amountWei) {
        this.error(`Insufficient balance. Available: ${ethers.formatUnits(bal, 18)} PHX`);
        return;
      }

      const spinner = ora("Submitting transaction...").start();
      const tx = await this.phx.connect(this.currentUser).transfer(recipient, amountWei);
      spinner.text = "Awaiting confirmation...";
      const receipt = await tx.wait();
      spinner.succeed("Transfer complete.");

    } catch (error) {
      this.error("Transfer failed: " + (error?.message || String(error)));
    }
  }

  async switchUser() { await this.selectUser(); }

  async viewAllBalances() {
    this.section("ALL USER BALANCES (Treasury Hidden)");
    try {
      const table = new Table({
        head: [this.theme.section("Idx"), this.theme.section("Address"), this.theme.section("Balance (PHX)"), this.theme.section("Status")],
        colWidths: [6, 48, 18, 12]
      });

      for (let i = 0; i < this.userAccounts.length; i++) {
        const addr = this.userAccounts[i].address;
        const bal = await this.phx.balanceOf(addr);
        const status = addr === this.currentUser.address ? this.theme.warn("ACTIVE") : "";
        table.push([this.theme.value(i.toString()), this.theme.value(addr), this.theme.ok(ethers.formatUnits(bal, 18)), status]);
      }

      console.log(table.toString());

      const treasuryBal = await this.phx.balanceOf(this.availableAccounts[0].address);
      console.log(this.theme.dim(`\nTreasury Balance: ${ethers.formatUnits(treasuryBal, 18)} PHX (Read-Only)`));
    } catch (error) {
      this.error(error?.message || String(error));
    }
  }

  // ---------- transaction history (CURRENT USER ONLY, arrow UI) ----------
  async viewTransactionHistory() {
    this.section("MY TRANSACTION HISTORY (current user)");

    try {
      if (!this.currentUser || !this.currentUser.address) {
        this.error("No current user selected.");
        return;
      }

      const me = String(this.currentUser.address).toLowerCase();
      const contractAddress = this.phx.address ?? this.phx.target ?? this.phx._address;
      if (!contractAddress) {
        this.error("Cannot determine contract address.");
        return;
      }

      const provider = ethers.provider;
      if (!provider) {
        this.error("Provider missing.");
        return;
      }

      // Query Transfer events
      const filter = this.phx.filters.Transfer();
      const events = await this.phx.queryFilter(filter, 0, "latest");

      // Filter only relevant events
      const myEvents = [];
      for (const ev of events) {
        const from = String(ev.args.from || ev.args[0]).toLowerCase();
        const to = String(ev.args.to || ev.args[1]).toLowerCase();

        if (from !== me && to !== me) continue;

        const b = await provider.getBlock(ev.blockNumber);
        const ts = b ? b.timestamp : null;

        myEvents.push({
          txHash: ev.transactionHash,
          from,
          to,
          value: ev.args.value || ev.args[2],
          time: ts ? new Date(Number(ts) * 1000).toLocaleString() : "n/a",
          blockNumber: ev.blockNumber
        });
      }

      if (myEvents.length === 0) {
        this.smallNote("No transactions found for the current user.");
        return;
      }

      myEvents.sort((a, b) => Number(b.blockNumber) - Number(a.blockNumber));

      for (const e of myEvents) {
        const shortHash = String(e.txHash).slice(0, 12) + "...";
        const fromShort = String(e.from).slice(0, 10) + (String(e.from).length > 10 ? "…" : "");
        const toShort = String(e.to).slice(0, 10) + (String(e.to).length > 10 ? "…" : "");
        const amount = ethers.formatUnits(e.value, 18);

        if (e.from === me) {
          console.log(this.theme.err(fromShort) + " " + this.theme.label("──────▶") + " " + this.theme.value(toShort));
          console.log(this.theme.label(" Amount: ") + this.theme.err(`-${amount} PHX`));
        } else {
          console.log(this.theme.value(fromShort) + " " + this.theme.label("──────▶") + " " + this.theme.ok("YOU"));
          console.log(this.theme.label(" Amount: ") + this.theme.ok(`+${amount} PHX`));
        }
        console.log(this.theme.label(" Time:   ") + this.theme.value(e.time));
        console.log(this.theme.label(" Tx:     ") + this.theme.value(shortHash));
        console.log(this.theme.dim("──────────────────────────────────────────────"));
      }

    } catch (error) {
      this.error("Failed to load history: " + (error?.message || String(error)));
    }
  }

  // ---------- system info ----------
  async showSystemInfo() {
    this.section("PHX SYSTEM INFORMATION");

    try {
      const totalSupply = await this.phx.totalSupply();
      const treasuryBalance = await this.phx.balanceOf(this.availableAccounts[0].address);
      const circulating = totalSupply - treasuryBalance;

      console.log(this.theme.section("Total Supply: ") + this.theme.value(ethers.formatUnits(totalSupply, 18) + " PHX"));
      console.log(this.theme.section("Treasury Reserve: ") + this.theme.value(ethers.formatUnits(treasuryBalance, 18) + " PHX"));
      console.log(this.theme.section("Circulating Supply: ") + this.theme.value(ethers.formatUnits(circulating, 18) + " PHX"));
      console.log(this.theme.section("Transfer Fee: ") + this.theme.value("0 PHX (No fees)"));

      console.log(this.theme.dim("\nTreasury operations restricted to Central Bank Console."));
    } catch (error) {
      this.error(error?.message || String(error));
    }
  }

  // ---------- main menu ----------
  async mainMenu() {
    while (true) {
      this.section("MAIN MENU");
      console.log(this.theme.value(" 1. Check My Balance"));
      console.log(this.theme.value(" 2. Check Address Balance"));
      console.log(this.theme.value(" 3. Transfer PHX"));
      console.log(this.theme.value(" 4. View All Balances"));
      console.log(this.theme.value(" 5. View Transaction History"));
      console.log(this.theme.value(" 6. Show System Info"));
      console.log(this.theme.value(" 7. Switch User"));
      console.log(this.theme.value(" 8. Exit\n"));

      const choice = (await this.question(this.theme.warn("Select option: "))).trim();

      if (choice === "1") await this.checkMyBalance();
      else if (choice === "2") await this.checkAddressBalance();
      else if (choice === "3") await this.transferToUser();
      else if (choice === "4") await this.viewAllBalances();
      else if (choice === "5") await this.viewTransactionHistory();
      else if (choice === "6") await this.showSystemInfo();
      else if (choice === "7") await this.switchUser();
      else if (choice === "8") {
        this.smallNote("Exiting wallet...");
        this.rl.close();
        process.exit(0);
      } else {
        this.error("Invalid selection.");
      }

      await this.question(this.theme.dim("\nPress Enter to continue..."));
    }
  }
}

// ---------- execution ----------
async function start() {
  const wallet = new PHXClientWallet();
  const ok = await wallet.initialize();
  if (ok) await wallet.mainMenu();
}
start();

